/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/@microsoft/signalr@8.0.7/dist/cjs/LongPollingTransport.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LongPollingTransport=void 0;const AbortController_1=require("./AbortController"),Errors_1=require("./Errors"),ILogger_1=require("./ILogger"),ITransport_1=require("./ITransport"),Utils_1=require("./Utils");class LongPollingTransport{get pollAborted(){return this._pollAbort.aborted}constructor(o,r,t){this._httpClient=o,this._logger=r,this._pollAbort=new AbortController_1.AbortController,this._options=t,this._running=!1,this.onreceive=null,this.onclose=null}async connect(o,r){if(Utils_1.Arg.isRequired(o,"url"),Utils_1.Arg.isRequired(r,"transferFormat"),Utils_1.Arg.isIn(r,ITransport_1.TransferFormat,"transferFormat"),this._url=o,this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) Connecting."),r===ITransport_1.TransferFormat.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof(new XMLHttpRequest).responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");const[t,e]=(0,Utils_1.getUserAgentHeader)(),s={[t]:e,...this._options.headers},n={abortSignal:this._pollAbort.signal,headers:s,timeout:1e5,withCredentials:this._options.withCredentials};r===ITransport_1.TransferFormat.Binary&&(n.responseType="arraybuffer");const g=`${o}&_=${Date.now()}`;this._logger.log(ILogger_1.LogLevel.Trace,`(LongPolling transport) polling: ${g}.`);const i=await this._httpClient.get(g,n);200!==i.statusCode?(this._logger.log(ILogger_1.LogLevel.Error,`(LongPolling transport) Unexpected response code: ${i.statusCode}.`),this._closeError=new Errors_1.HttpError(i.statusText||"",i.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,n)}async _poll(o,r){try{for(;this._running;)try{const t=`${o}&_=${Date.now()}`;this._logger.log(ILogger_1.LogLevel.Trace,`(LongPolling transport) polling: ${t}.`);const e=await this._httpClient.get(t,r);204===e.statusCode?(this._logger.log(ILogger_1.LogLevel.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==e.statusCode?(this._logger.log(ILogger_1.LogLevel.Error,`(LongPolling transport) Unexpected response code: ${e.statusCode}.`),this._closeError=new Errors_1.HttpError(e.statusText||"",e.statusCode),this._running=!1):e.content?(this._logger.log(ILogger_1.LogLevel.Trace,`(LongPolling transport) data received. ${(0,Utils_1.getDataDetail)(e.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(e.content)):this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(o){this._running?o instanceof Errors_1.TimeoutError?this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=o,this._running=!1):this._logger.log(ILogger_1.LogLevel.Trace,`(LongPolling transport) Poll errored after shutdown: ${o.message}`)}}finally{this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(o){return this._running?(0,Utils_1.sendMessage)(this._logger,"LongPolling",this._httpClient,this._url,o,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{await this._receiving,this._logger.log(ILogger_1.LogLevel.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);const o={},[r,t]=(0,Utils_1.getUserAgentHeader)();o[r]=t;const e={headers:{...o,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};let s;try{await this._httpClient.delete(this._url,e)}catch(o){s=o}s?s instanceof Errors_1.HttpError&&(404===s.statusCode?this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(ILogger_1.LogLevel.Trace,`(LongPolling transport) Error sending a DELETE request: ${s}`)):this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(ILogger_1.LogLevel.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let o="(LongPolling transport) Firing onclose event.";this._closeError&&(o+=" Error: "+this._closeError),this._logger.log(ILogger_1.LogLevel.Trace,o),this.onclose(this._closeError)}}}exports.LongPollingTransport=LongPollingTransport;
//# sourceMappingURL=/sm/f3985309fbf71a821585627d7734ea53f872f11baec7558924637cfa45a95dc0.map