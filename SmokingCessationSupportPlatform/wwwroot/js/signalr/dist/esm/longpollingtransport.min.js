/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/@microsoft/signalr@8.0.7/dist/esm/LongPollingTransport.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{AbortController}from"./AbortController";import{HttpError,TimeoutError}from"./Errors";import{LogLevel}from"./ILogger";import{TransferFormat}from"./ITransport";import{Arg,getDataDetail,getUserAgentHeader,sendMessage}from"./Utils";export class LongPollingTransport{get pollAborted(){return this._pollAbort.aborted}constructor(t,e,o){this._httpClient=t,this._logger=e,this._pollAbort=new AbortController,this._options=o,this._running=!1,this.onreceive=null,this.onclose=null}async connect(t,e){if(Arg.isRequired(t,"url"),Arg.isRequired(e,"transferFormat"),Arg.isIn(e,TransferFormat,"transferFormat"),this._url=t,this._logger.log(LogLevel.Trace,"(LongPolling transport) Connecting."),e===TransferFormat.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof(new XMLHttpRequest).responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");const[o,r]=getUserAgentHeader(),n={[o]:r,...this._options.headers},s={abortSignal:this._pollAbort.signal,headers:n,timeout:1e5,withCredentials:this._options.withCredentials};e===TransferFormat.Binary&&(s.responseType="arraybuffer");const i=`${t}&_=${Date.now()}`;this._logger.log(LogLevel.Trace,`(LongPolling transport) polling: ${i}.`);const l=await this._httpClient.get(i,s);200!==l.statusCode?(this._logger.log(LogLevel.Error,`(LongPolling transport) Unexpected response code: ${l.statusCode}.`),this._closeError=new HttpError(l.statusText||"",l.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,s)}async _poll(t,e){try{for(;this._running;)try{const o=`${t}&_=${Date.now()}`;this._logger.log(LogLevel.Trace,`(LongPolling transport) polling: ${o}.`);const r=await this._httpClient.get(o,e);204===r.statusCode?(this._logger.log(LogLevel.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==r.statusCode?(this._logger.log(LogLevel.Error,`(LongPolling transport) Unexpected response code: ${r.statusCode}.`),this._closeError=new HttpError(r.statusText||"",r.statusCode),this._running=!1):r.content?(this._logger.log(LogLevel.Trace,`(LongPolling transport) data received. ${getDataDetail(r.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(r.content)):this._logger.log(LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(t){this._running?t instanceof TimeoutError?this._logger.log(LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=t,this._running=!1):this._logger.log(LogLevel.Trace,`(LongPolling transport) Poll errored after shutdown: ${t.message}`)}}finally{this._logger.log(LogLevel.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(t){return this._running?sendMessage(this._logger,"LongPolling",this._httpClient,this._url,t,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(LogLevel.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{await this._receiving,this._logger.log(LogLevel.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);const t={},[e,o]=getUserAgentHeader();t[e]=o;const r={headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};let n;try{await this._httpClient.delete(this._url,r)}catch(t){n=t}n?n instanceof HttpError&&(404===n.statusCode?this._logger.log(LogLevel.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(LogLevel.Trace,`(LongPolling transport) Error sending a DELETE request: ${n}`)):this._logger.log(LogLevel.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(LogLevel.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let t="(LongPolling transport) Firing onclose event.";this._closeError&&(t+=" Error: "+this._closeError),this._logger.log(LogLevel.Trace,t),this.onclose(this._closeError)}}}
//# sourceMappingURL=/sm/69b6bf6b6949806a69bf1632faf4cb1a017d6552444bbd16316e345e2d9aa060.map